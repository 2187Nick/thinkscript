# Rising Value Upper Feb 27, 2024
# Twitter @2187Nick

input lookback = 10;
input ManuallySetExpiration = {default "false", "true"};
input Expiration_YYMMDD = 240315;
input ManuallySetStrikes = {default "false", "true"};
input Strike1 = 510.0;
input Strike2 = 511.0;

def DateString_auto = GetYYYYMMDD()-20000000;
def DateString = if manuallysetexpiration then Expiration_YYMMDD else  DateString_auto;

DefineGlobalColor("CallColor", Color.GREEN);
DefineGlobalColor("CallColor2", Color.CYAN);
DefineGlobalColor("PutColor", Color.RED);
DefineGlobalColor("PutColor2", Color.Violet);

addlabel(1, lookback + ": " + "üêÇ",  GlobalColor("CallColor"));
addlabel(1, lookback + ": " + "üêÇ",  GlobalColor("CallColor2"));
addlabel(1, lookback + ": " + "üêº",  GlobalColor("PutColor"));
addlabel(1, lookback + ": " + "üêº",  GlobalColor("PutColor2"));


def strike1_auto = floor(open);
def strike2_auto = ceil(open);

def price1 = if ManuallySetStrikes then strike1 else strike1_auto;
def price2 = if ManuallySetStrikes then strike2 else strike2_auto;

def call_option_value = open("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price1));
def call_option_value10 = close("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price1))[lookback];
def equity_price = open;
def equity_price10 = close[lookback];

def equity_diff = equity_price - equity_price10;

def option_diff = call_option_value - call_option_value10;

def call_option_value2 = open("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price2));
def call_option_value2_10 = close("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price2))[lookback];
def option_diff2 = call_option_value2 - call_option_value2_10;

## Bullish divergence.
# Equity price is down and call option is flat to up.
addchartbubble(equity_diff < 0 and option_diff >= 0, low, "üêÇ"+price1, GlobalColor("CallColor"), no);
addchartbubble(equity_diff < 0 and option_diff2 >= 0, low, "üêÇ"+price2, GlobalColor("CallColor2"), no);


## Bearish divergence
def put_option_value = open("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price1));
def put_option_value10 = close("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price1))[lookback];
def put_option_diff = put_option_value - put_option_value10;

# Equity price is up and put option is flat to up.
addchartbubble(equity_diff > 0 and put_option_diff >= 0, high, "üêº" +price1, GlobalColor("PutColor"));

def put_option_value2 = open("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price2));
def put_option_value2_10 = close("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price2))[lookback];
def put_option_diff2 = put_option_value2 - put_option_value2_10;

# Equity price is up and put option is flat to up.
addchartbubble(equity_diff > 0 and put_option_diff2 >= 0, high, "üêº"+price2, GlobalColor("PutColor2"));
