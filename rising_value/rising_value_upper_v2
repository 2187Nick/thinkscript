# Rising Value Upper V2 Feb 28 , 2024
# Twitter @2187Nick

input lookbackperiodstart = 3;
input lookbackPeriod = 15;
input ManuallySetExpiration = {default "false", "true"};
input Expiration_YYMMDD = 240315;
#input ManuallySetStrikes = {default "false", "true"};
input Strike1 = 505.0;
input Strike2 = 506.0;
input minimum = .01;
input bull = "üêÇ";
input bear = "üêº";


def DateString_auto = GetYYYYMMDD()-20000000;
def DateString = if manuallysetexpiration then Expiration_YYMMDD else  DateString_auto;

DefineGlobalColor("CallColor", Color.GREEN);
DefineGlobalColor("CallColor2", Color.CYAN);
DefineGlobalColor("CallColor3", Color.light_green);
DefineGlobalColor("CallColor4", Color.light_gray);
DefineGlobalColor("PutColor", Color.RED);
DefineGlobalColor("PutColor2", Color.Violet);
DefineGlobalColor("PutColor3", Color.light_red);
DefineGlobalColor("PutColor4", Color.orange);

addlabel(1, Strike1 + " " + lookbackPeriod + ": " + "üêÇ",  GlobalColor("CallColor"));
addlabel(1, Strike2 + " " + lookbackPeriod + ": " + "üêÇ",  GlobalColor("CallColor2"));
addlabel(1, Strike1 + " " + lookbackPeriod + ": " + "üêº",  GlobalColor("PutColor"));
addlabel(1, Strike2 + " " + lookbackPeriod + ": " + "üêº",  GlobalColor("PutColor2"));

def strike1_auto = floor(open);
def strike2_auto = ceil(open);

def price1 = strike1;
def price2 = strike2;

def call_option_value = open("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price1));
def call_option_value_close = close("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price1));

def call_option_value2 = open("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price2));
def call_option_value2_close = close("." + getSymbol() + AsPrice(DateString) + "C" + AsPrice(price2));

def currentStockPrice = open;

# Bullish divergence detection using fold
# Stock current price open is lower than a previous close price AND
# The call option open price now is higher than option price at that time.
def bullishDivergence = fold g = lookbackperiodstart to lookbackPeriod with bullish = 0 do bullish + (if currentStockPrice < GetValue(close, g) and GetValue(call_option_value_close, g) + minimum <= call_option_value then 1 else 0);
#plot bullishDivergence1 = bullishDivergence;
#bullishDivergence1.setDefaultColor(GlobalColor("CallColor"));

def bullishDivergence2 = fold h = lookbackperiodstart to lookbackPeriod with bullish2 = 0 do bullish2 + (if currentStockPrice < GetValue(close, h) and GetValue(call_option_value2_close, h) + minimum <= call_option_value2 then 1 else 0);
#plot bullishDivergence2a = bullishDivergence2;
#bullishDivergence2a.setDefaultColor(GlobalColor("CallColor2"));

# Equity price is up and call option is up.
addchartbubble(bullishDivergence, low, bull + price1, GlobalColor("CallColor"),no);
addchartbubble(bullishDivergence2, low, bull + price2, GlobalColor("CallColor2"), no);

## Bearish divergence
def put_option_value = open("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price1));

def put_option_value_close = close("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price1));

def put_option_value2 = open("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price2));
def put_option_value2_close = close("." + getSymbol() + AsPrice(DateString) + "P" + AsPrice(price2));

# Bearish divergence detection using fold
# Stock current price open is higher than a previous close price AND
# The put option open price now is higher than option price at that time.
def bearishDivergence = fold i = lookbackperiodstart to lookbackPeriod with bearish = 0 do bearish + if GetValue(close, i) < currentStockPrice and GetValue(put_option_value_close, i) + minimum <= put_option_value then 1 else 0;
#plot bearishDivergence1 = bearishDivergence;
#bearishDivergence1.setDefaultColor(GlobalColor("PutColor"));

def bearishDivergence2 = fold j = lookbackperiodstart to lookbackPeriod with bearish2 = 0 do bearish2 + if GetValue(close, j) < currentStockPrice and GetValue(put_option_value2_close, j) + minimum <= put_option_value2 then 1 else 0;
#plot bearishDivergence2a = bearishDivergence2;
#bearishDivergence2a.setDefaultColor(GlobalColor("PutColor2"));


# Equity price is up and call option is up.
addchartbubble(bearishDivergence, high, bear + price1, GlobalColor("PutColor"));
addchartbubble(bearishDivergence2, high, bear + price2, GlobalColor("PutColor2"));
